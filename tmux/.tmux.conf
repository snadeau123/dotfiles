# ═══════════════════════════════════════════════════════════════════════════
# TMUX Configuration - Clean & Validated
# Based on Oh My Tmux but simplified and thoroughly reviewed
# ═══════════════════════════════════════════════════════════════════════════

# ───────────────────────────────────────────────────────────────────────────
# General Settings
# ───────────────────────────────────────────────────────────────────────────

# Use zsh as default shell
set-option -g default-shell /usr/bin/zsh

# Enable 256 color support
set -g default-terminal "screen-256color"

# Enable true color support if available
set -ga terminal-overrides ",*256col*:Tc"

# Faster command sequences (reduce escape time)
set -s escape-time 10

# Increase repeat timeout for repeated commands
set -sg repeat-time 600

# Enable focus events for terminal-based applications
set -s focus-events on

# Boost scrollback history
set -g history-limit 10000

# Enable mouse support
# NOTE: When mouse mode is on, hold SHIFT while selecting to copy with terminal
# Or use prefix + m to toggle mouse mode on/off
set -g mouse on

# Copy selection to clipboard when mouse is released in copy mode
bind -T copy-mode-vi MouseDragEnd1Pane send -X copy-selection-and-cancel

# ───────────────────────────────────────────────────────────────────────────
# Prefix Key Configuration
# ───────────────────────────────────────────────────────────────────────────

# Keep default C-b prefix, add C-a as secondary (GNU Screen compatibility)
set -g prefix2 C-a
bind C-a send-prefix -2

# ───────────────────────────────────────────────────────────────────────────
# Window & Pane Numbering
# ───────────────────────────────────────────────────────────────────────────

# Start window numbering at 1 (easier to reach on keyboard)
set -g base-index 1

# Start pane numbering at 1 (consistent with windows)
setw -g pane-base-index 1

# Renumber windows when one is closed
set -g renumber-windows on

# Automatically rename windows based on running program
setw -g automatic-rename on

# Set terminal title
set -g set-titles on
set -g set-titles-string "#h • #S • #I:#W"

# ───────────────────────────────────────────────────────────────────────────
# Status Bar Configuration
# ───────────────────────────────────────────────────────────────────────────

# Update status bar every 5 seconds
set -g status-interval 5

# Status bar position
set -g status-position bottom

# Status bar styling
set -g status-style 'bg=#1e1e1e fg=#a8a8a8'

# Left status bar: session name
set -g status-left '#[bg=#00afff,fg=#000000,bold] #S #[bg=#1e1e1e] '
set -g status-left-length 50

# Right status bar: date and time
# Without battery (default for desktops)
set -g status-right '#[bg=#303030,fg=#a8a8a8] %Y-%m-%d #[bg=#00afff,fg=#000000,bold] %H:%M '
# With battery (uncomment for laptops and comment line above)
# set -g status-right '#(sh -c "#{@battery_script}") #[bg=#303030,fg=#a8a8a8] %Y-%m-%d #[bg=#00afff,fg=#000000,bold] %H:%M '
set -g status-right-length 50

# Window status styling
setw -g window-status-format ' #I:#W '
setw -g window-status-current-format '#[bg=#00afff,fg=#000000,bold] #I:#W '
setw -g window-status-separator ''

# Activity monitoring
set -g monitor-activity on
set -g visual-activity off
setw -g window-status-activity-style 'bg=#303030,fg=#ffff00'

# ───────────────────────────────────────────────────────────────────────────
# Pane Styling
# ───────────────────────────────────────────────────────────────────────────

# Pane borders
set -g pane-border-style 'fg=#303030'
set -g pane-active-border-style 'fg=#00afff'

# Pane number display (prefix + q)
set -g display-panes-time 2000
set -g display-panes-colour '#303030'
set -g display-panes-active-colour '#00afff'

# ───────────────────────────────────────────────────────────────────────────
# Key Bindings - General
# ───────────────────────────────────────────────────────────────────────────

# Reload configuration
bind r source-file ~/.tmux.conf \; display "Config reloaded"

# Toggle mouse mode (useful for copying text in terminal over SSH)
bind m set -g mouse \; display "Mouse: #{?mouse,ON,OFF}"

# Clear screen and history (similar to C-l in shell)
bind -n C-l send-keys C-l \; clear-history

# ───────────────────────────────────────────────────────────────────────────
# Key Bindings - Session Management
# ───────────────────────────────────────────────────────────────────────────

# Create new session
bind C-c new-session

# Find session
bind C-f command-prompt -p "find-session:" "switch-client -t %%"

# Switch to last session
bind BTab switch-client -l

# ───────────────────────────────────────────────────────────────────────────
# Key Bindings - Window Management
# ───────────────────────────────────────────────────────────────────────────

# Switch windows (prefix + C-h/C-l)
unbind n
unbind p
bind -r C-h previous-window
bind -r C-l next-window

# Switch to last window (prefix + Tab)
bind Tab last-window

# Swap windows
bind -r C-S-H swap-window -t -1 \; select-window -t -1
bind -r C-S-L swap-window -t +1 \; select-window -t +1

# ───────────────────────────────────────────────────────────────────────────
# Key Bindings - Pane Management
# ───────────────────────────────────────────────────────────────────────────

# Split panes (more intuitive)
bind - split-window -v -c "#{pane_current_path}"
bind _ split-window -h -c "#{pane_current_path}"

# Vim-style pane navigation
bind -r h select-pane -L
bind -r j select-pane -D
bind -r k select-pane -U
bind -r l select-pane -R

# Vim-style pane resizing
bind -r H resize-pane -L 5
bind -r J resize-pane -D 5
bind -r K resize-pane -U 5
bind -r L resize-pane -R 5

# Swap panes
bind > swap-pane -D
bind < swap-pane -U

# Toggle pane zoom
bind z resize-pane -Z

# ───────────────────────────────────────────────────────────────────────────
# Key Bindings - Copy Mode
# ───────────────────────────────────────────────────────────────────────────

# Enter copy mode
bind Enter copy-mode

# Vim-style copy mode bindings
setw -g mode-keys vi

bind -T copy-mode-vi v send -X begin-selection
bind -T copy-mode-vi C-v send -X rectangle-toggle
bind -T copy-mode-vi y send -X copy-selection-and-cancel
bind -T copy-mode-vi Escape send -X cancel
bind -T copy-mode-vi H send -X start-of-line
bind -T copy-mode-vi L send -X end-of-line

# ───────────────────────────────────────────────────────────────────────────
# Clipboard Integration
# ───────────────────────────────────────────────────────────────────────────

# Enable OSC52 clipboard (works over SSH)
set -g set-clipboard on

# Copy to system clipboard (detects available clipboard tool)
# Linux X11
if-shell 'command -v xclip > /dev/null 2>&1' \
    'bind -T copy-mode-vi y send -X copy-pipe-and-cancel "xclip -i -selection clipboard"'

# Linux Wayland
if-shell '[ "$XDG_SESSION_TYPE" = "wayland" ] && command -v wl-copy > /dev/null 2>&1' \
    'bind -T copy-mode-vi y send -X copy-pipe-and-cancel "wl-copy"'

# macOS
if-shell 'command -v pbcopy > /dev/null 2>&1' \
    'bind -T copy-mode-vi y send -X copy-pipe-and-cancel "pbcopy"'

# WSL
if-shell 'command -v clip.exe > /dev/null 2>&1' \
    'bind -T copy-mode-vi y send -X copy-pipe-and-cancel "clip.exe"'

# ───────────────────────────────────────────────────────────────────────────
# Key Bindings - Buffer Management
# ───────────────────────────────────────────────────────────────────────────

# List paste buffers
bind b list-buffers

# Paste from top buffer
bind p paste-buffer -p

# Choose buffer to paste
bind P choose-buffer

# ───────────────────────────────────────────────────────────────────────────
# Optional Features - Battery Indicator
# ───────────────────────────────────────────────────────────────────────────

# Battery status script - works on Linux (sysfs/upower) and macOS (pmset)
# To enable: see "Status Bar Configuration" section above (around line 80)

# Battery enabled flag - set to true when using battery status bar
set -g @battery_enabled false
# set -g @battery_enabled true  # Uncomment when enabling battery

# Battery status script
set -g @battery_script "\
ENABLED='#{@battery_enabled}'; \
if [ \"$ENABLED\" = 'false' ]; then exit 0; fi; \
if [ -d /sys/class/power_supply ]; then \
  for bat in /sys/class/power_supply/BAT*; do \
    if [ -f \"$bat/capacity\" ]; then \
      PCT=$(cat \"$bat/capacity\"); \
      STATUS=$(cat \"$bat/status\"); \
      if [ \"$STATUS\" = 'Charging' ]; then \
        echo \"↑ $PCT%\"; \
      elif [ \"$STATUS\" = 'Discharging' ]; then \
        echo \"↓ $PCT%\"; \
      else \
        echo \"$PCT%\"; \
      fi; \
      exit 0; \
    fi; \
  done; \
elif command -v pmset >/dev/null 2>&1; then \
  pmset -g batt | grep -Eo '[0-9]+%' | head -1; \
elif command -v upower >/dev/null 2>&1; then \
  BAT=$(upower -e | grep -i 'BAT' | head -1); \
  if [ -n \"$BAT\" ]; then \
    PCT=$(upower -i \"$BAT\" | grep percentage | awk '{print $2}'); \
    STATE=$(upower -i \"$BAT\" | grep state | awk '{print $2}'); \
    if [ \"$STATE\" = 'charging' ]; then \
      echo \"↑ $PCT\"; \
    elif [ \"$STATE\" = 'discharging' ]; then \
      echo \"↓ $PCT\"; \
    else \
      echo \"$PCT\"; \
    fi; \
  fi; \
fi"

# ───────────────────────────────────────────────────────────────────────────
# Plugins (Optional - uncomment if using TPM)
# ───────────────────────────────────────────────────────────────────────────

# Plugin manager: https://github.com/tmux-plugins/tpm
# To install TPM:
#   git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm
# Then press prefix + I to install plugins

# set -g @plugin 'tmux-plugins/tpm'
# set -g @plugin 'tmux-plugins/tmux-sensible'
# set -g @plugin 'tmux-plugins/tmux-resurrect'
# set -g @plugin 'tmux-plugins/tmux-continuum'

# Initialize TPM (keep this line at the very bottom)
# run '~/.tmux/plugins/tpm/tpm'
